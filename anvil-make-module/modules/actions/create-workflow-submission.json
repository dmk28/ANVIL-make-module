{
  "name": "createWorkflowSubmission",
  "label": "Create Workflow Submission",
  "description": "Start a new workflow submission with data to fill forms and PDFs. Triggers the workflow process in Anvil.",
  "type": "action",
  "connection": "anvil",
  "communication": {
    "url": "https://graphql.useanvil.com",
    "method": "POST",
    "headers": {
      "Content-Type": "application/json",
      "Authorization": "Basic {{base64(connection.apiKey + ':')}}"
    },
    "body": {
      "query": "mutation CreateWeldData($weldEid: String!, $webhookURL: String, $isTest: Boolean, $data: JSONObject) { createWeldData(weldEid: $weldEid, webhookURL: $webhookURL, isTest: $isTest, data: $data) { eid status continueURL isTest weld { eid name slug } submissions { eid status forge { eid name } } documentGroup { eid status } } }",
      "variables": {
        "weldEid": "{{parameters.weldEid}}",
        "webhookURL": "{{parameters.webhookUrl}}",
        "isTest": "{{parameters.isTest}}",
        "data": "{{parameters.data}}"
      }
    },
    "response": {
      "output": {
        "weldDataId": "{{body.data.createWeldData.eid}}",
        "status": "{{body.data.createWeldData.status}}",
        "continueURL": "{{body.data.createWeldData.continueURL}}",
        "isTest": "{{body.data.createWeldData.isTest}}",
        "weld": "{{body.data.createWeldData.weld}}",
        "submissions": "{{body.data.createWeldData.submissions}}",
        "documentGroup": "{{body.data.createWeldData.documentGroup}}",
        "createdAt": "{{now}}"
      },
      "error": {
        "message": "{{if(body.errors; body.errors[0].message; if(body.error; body.error; if(body.message; body.message; 'Failed to create workflow submission'))))}}"
      }
    },
    "log": {
      "sanitize": [
        "request.headers.Authorization"
      ]
    }
  },
  "parameters": [
    {
      "name": "weldEid",
      "label": "Workflow ID",
      "type": "text",
      "required": true,
      "help": "The EID of the workflow (Weld) to start. Find this in Anvil under your workflow's settings.",
      "mappable": true
    },
    {
      "name": "data",
      "label": "Workflow Data",
      "type": "json",
      "required": false,
      "help": "JSON object with data to fill the workflow forms. Keys should match field aliases in your workflow.",
      "mappable": true
    },
    {
      "name": "isTest",
      "label": "Test Mode",
      "type": "boolean",
      "required": false,
      "default": false,
      "help": "If true, creates a test submission that doesn't count toward quotas"
    },
    {
      "name": "webhookUrl",
      "label": "Webhook URL",
      "type": "url",
      "required": false,
      "help": "URL to receive webhook notifications when the workflow completes",
      "advanced": true,
      "mappable": true
    }
  ],
  "interface": [
    {
      "name": "weldDataId",
      "label": "Submission ID",
      "type": "text"
    },
    {
      "name": "status",
      "label": "Status",
      "type": "text"
    },
    {
      "name": "continueURL",
      "label": "Continue URL",
      "type": "url"
    },
    {
      "name": "isTest",
      "label": "Is Test",
      "type": "boolean"
    },
    {
      "name": "createdAt",
      "label": "Created At",
      "type": "date"
    },
    {
      "name": "weld",
      "label": "Workflow",
      "type": "collection",
      "spec": [
        {
          "name": "eid",
          "type": "text"
        },
        {
          "name": "name",
          "type": "text"
        },
        {
          "name": "slug",
          "type": "text"
        }
      ]
    },
    {
      "name": "submissions",
      "label": "Submissions",
      "type": "array",
      "spec": {
        "type": "collection",
        "spec": [
          {
            "name": "eid",
            "type": "text"
          },
          {
            "name": "status",
            "type": "text"
          },
          {
            "name": "forge",
            "type": "collection",
            "spec": [
              {
                "name": "eid",
                "type": "text"
              },
              {
                "name": "name",
                "type": "text"
              }
            ]
          }
        ]
      }
    },
    {
      "name": "documentGroup",
      "label": "Document Group",
      "type": "collection",
      "spec": [
        {
          "name": "eid",
          "type": "text"
        },
        {
          "name": "status",
          "type": "text"
        }
      ]
    }
  ]
}
