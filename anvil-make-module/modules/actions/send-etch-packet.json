{
  "name": "sendEtchPacket",
  "label": "Send an E-Signature Packet",
  "description": "Send a draft e-signature packet to its signers. Only works on packets created with isDraft=true.",
  "type": "action",
  "connection": "anvil",
  "communication": {
    "url": "https://graphql.useanvil.com",
    "method": "POST",
    "headers": {
      "Content-Type": "application/json",
      "Authorization": "Basic {{base64(connection.apiKey + ':')}}"
    },
    "body": {
      "query": "mutation SendEtchPacket($eid: String!) { sendEtchPacket(eid: $eid) { eid name status isDraft createdAt documentGroup { eid status signers { eid name email status } } signers { eid name email status signerType routingOrder } } }",
      "variables": {
        "eid": "{{parameters.packetEid}}"
      }
    },
    "response": {
      "output": {
        "packetEid": "{{body.data.sendEtchPacket.eid}}",
        "name": "{{body.data.sendEtchPacket.name}}",
        "status": "{{body.data.sendEtchPacket.status}}",
        "isDraft": "{{body.data.sendEtchPacket.isDraft}}",
        "createdAt": "{{body.data.sendEtchPacket.createdAt}}",
        "documentGroup": "{{body.data.sendEtchPacket.documentGroup}}",
        "signers": "{{body.data.sendEtchPacket.signers}}",
        "sentAt": "{{now}}"
      },
      "error": {
        "message": "{{if(body.errors; body.errors[0].message; if(body.error; body.error; if(body.message; body.message; 'Failed to send e-signature packet'))))}}"
      }
    },
    "log": {
      "sanitize": [
        "request.headers.Authorization"
      ]
    }
  },
  "parameters": [
    {
      "name": "packetEid",
      "label": "Packet ID",
      "type": "text",
      "required": true,
      "help": "The EID of the draft e-signature packet to send",
      "mappable": true
    }
  ],
  "interface": [
    {
      "name": "packetEid",
      "label": "Packet ID",
      "type": "text"
    },
    {
      "name": "name",
      "label": "Packet Name",
      "type": "text"
    },
    {
      "name": "status",
      "label": "Status",
      "type": "text"
    },
    {
      "name": "isDraft",
      "label": "Is Draft",
      "type": "boolean"
    },
    {
      "name": "createdAt",
      "label": "Created At",
      "type": "date"
    },
    {
      "name": "sentAt",
      "label": "Sent At",
      "type": "date"
    },
    {
      "name": "documentGroup",
      "label": "Document Group",
      "type": "collection",
      "spec": [
        {
          "name": "eid",
          "type": "text"
        },
        {
          "name": "status",
          "type": "text"
        }
      ]
    },
    {
      "name": "signers",
      "label": "Signers",
      "type": "array",
      "spec": {
        "type": "collection",
        "spec": [
          {
            "name": "eid",
            "type": "text"
          },
          {
            "name": "name",
            "type": "text"
          },
          {
            "name": "email",
            "type": "email"
          },
          {
            "name": "status",
            "type": "text"
          },
          {
            "name": "signerType",
            "type": "text"
          },
          {
            "name": "routingOrder",
            "type": "integer"
          }
        ]
      }
    }
  ]
}
